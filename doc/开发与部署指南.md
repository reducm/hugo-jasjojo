# Hugo 博客开发与部署指南

## 项目概览

| 项目 | 说明 |
|------|------|
| 仓库 | `reducm/hugo-jasjojo` |
| 主题 | hugo-coder |
| 线上地址 | https://jasjojo.com/ |
| Hugo 版本 | v0.102.0+extended（线上和本地需保持一致） |
| Web 服务器 | Caddy（直接托管 public/ 目录） |

## 项目结构

```
hugo-jasjojo/
├── archetypes/          # 文章模板
├── assets/css/          # 自定义 CSS（经 Hugo 资源管线处理）
│   └── toc.css          # 右侧目录侧边栏样式
├── content/posts/       # 博客文章（Markdown）
├── layouts/posts/       # 覆盖主题的文章模板
│   └── single.html      # 文章详情页（含 TOC 侧边栏）
├── static/              # 静态资源（JS、图片等）
│   ├── css/toc.css      # [遗留] 旧版 toc.css，未被引用
│   └── js/              # Mermaid 等 JS 库
├── themes/hugo-coder/   # 主题（不要修改）
├── scripts/deploy.sh    # rsync 部署脚本
├── config.yaml          # Hugo 配置
└── public/              # 构建输出（.gitignore 中）
```

## 本地开发

### 前置条件

- Hugo v0.102.0+extended（arm64 或对应架构）
- 安装方式：从 [GitHub Releases](https://github.com/gohugoio/hugo/releases/tag/v0.102.0) 下载预编译二进制包

> **注意：** 不要使用过新的 Hugo 版本（如 0.145.0），hugo-coder 主题的 `.Site.IsServer` API 不兼容。

### 启动开发服务器

```bash
cd /home/jojo/.openclaw/workspace/hugo-jasjojo
hugo server --bind 0.0.0.0 --port 1313
```

功能：
- 实时预览：http://localhost:1313/
- 文件修改自动热重载（Fast Render 模式）
- 草稿文章也会渲染

加 `-D` 参数可以同时渲染 `draft: true` 的草稿文章：

```bash
hugo server --bind 0.0.0.0 --port 1313 -D
```

### 创建新文章

```bash
hugo new posts/2026-02-10-my-new-post.md
```

文章命名规范：`YYYY-MM-DD-标题关键词.md`

### 常用本地命令

| 命令 | 说明 |
|------|------|
| `hugo server` | 启动开发服务器 |
| `hugo server -D` | 启动开发服务器（包含草稿） |
| `hugo` | 只构建静态文件到 public/ |
| `hugo new posts/xxx.md` | 创建新文章 |

## 线上部署

### 服务器信息

| 项目 | 说明 |
|------|------|
| SSH 别名 | `jas_tcloud` |
| 博客源码路径 | `/home/jojo/project/hugo-jasjojo` |
| Hugo 二进制路径 | `/home/jojo/project/hugo/hugo` |
| Hugo 版本 | v0.102.0+extended linux/amd64 |
| Caddy 配置 | `/home/jojo/project/Caddyfile` |
| 静态文件目录 | `/home/jojo/project/hugo-jasjojo/public` |

### Caddy 配置

Caddy 直接托管 `public/` 目录作为静态文件服务器：

```
jasjojo.com {
  root * /home/jojo/project/hugo-jasjojo/public
  file_server
}
```

Hugo 构建后生成的静态文件直接被 Caddy 服务，**无需重启 Caddy**。

### 方式一：使用部署脚本（推荐）

项目中的 `scripts/deploy.sh` 一键完成：git 提交 -> git push -> rsync 同步 -> 远程 hugo 构建。

```bash
cd /home/jojo/.openclaw/workspace/hugo-jasjojo

# 带自定义提交信息
bash scripts/deploy.sh "添加新文章：xxx"

# 使用默认提交信息 "部署更新"
bash scripts/deploy.sh
```

脚本流程：
1. 检测本地改动，自动 `git add . && git commit && git push`
2. `rsync` 同步文件到服务器（排除 public/、.git/、resources/）
3. 在服务器上执行 `/home/jojo/project/hugo/hugo` 构建
4. 完成，访问 https://jasjojo.com/ 即可看到更新

### 方式二：手动部署

如果需要手动操作，步骤如下：

```bash
# 1. 同步文件到服务器
rsync -avz --progress \
    --exclude 'public/' \
    --exclude 'resources/' \
    --exclude '.git/' \
    --exclude '.hugo_build.lock' \
    ./ jojo@jas_tcloud:/home/jojo/project/hugo-jasjojo/

# 2. SSH 到服务器构建
ssh jas_tcloud "cd /home/jojo/project/hugo-jasjojo && /home/jojo/project/hugo/hugo"
```

### 方式三：只同步单个文件

如果只修改了某个模板或样式文件，可以直接 scp：

```bash
# 例如同步 single.html
scp layouts/posts/single.html jas_tcloud:/home/jojo/project/hugo-jasjojo/layouts/posts/single.html

# 然后远程构建
ssh jas_tcloud "cd /home/jojo/project/hugo-jasjojo && /home/jojo/project/hugo/hugo"
```

## TOC（目录侧边栏）架构说明

### 文件关系

```
config.yaml                    # tableOfContents 配置 + customCSS 引用
  ↓
layouts/posts/single.html      # HTML 结构：post-container + toc-sidebar
  ↓
assets/css/toc.css             # CSS 样式：Grid 布局 + sticky 定位
```

### 工作原理

1. `config.yaml` 中 `markup.tableOfContents` 配置 Hugo 自动提取 h2-h4 标题
2. `single.html` 中 `{{ .TableOfContents }}` 输出目录 HTML
3. `post-container` 使用 CSS Grid 实现文章+目录左右布局
4. `toc-sidebar` 使用 `position: sticky` 实现滚动时固定
5. 1024px 以下（手机/平板）自动隐藏目录侧边栏

### 历史教训

Mermaid 11.x 迁移时（提交 `a983aec` → `f3b4799`）重写了 `single.html`，意外丢失了 TOC 的 HTML 结构。修改此文件时务必保留 `post-container` 和 `toc-sidebar` 结构。

## 注意事项

1. **Hugo 版本**：必须使用 v0.102.0，不要升级。新版本 API 与 hugo-coder 主题不兼容
2. **主题文件**：`themes/hugo-coder/` 目录不要修改，通过 `layouts/` 覆盖
3. **CSS 加载**：自定义 CSS 放在 `assets/css/`，通过 `config.yaml` 的 `customCSS` 引用
4. **static/css/toc.css**：是遗留文件，未被引用，实际生效的是 `assets/css/toc.css`
5. **构建后无需重启 Caddy**：Caddy 直接托管 public/ 目录，hugo 构建完即生效
